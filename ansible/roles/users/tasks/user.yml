---

- name: Configure "{{ user.username }}" user account
  ansible.builtin.user:
    uid: "{{ user.uid | default(omit) }}"
    name: "{{ user.username }}"
    password: "{{ user.password | default('!') }}"
    comment: "{{ user.name | default('a user has no name') }}"
    groups: "{{ user.groups | default([]) | join(',') }}"
    shell: "{{ user.shell | default('/bin/bash') }}"
    createhome: "{{ user.home | default(false) }}"
    append: true
  when: user.name is defined
  become: true
  tags:
    - users

- name: Secure "{{ user.username }}" user ssh directory
  ansible.builtin.file:
    group: "{{ user.username }}"
    mode: 0700
    owner: "{{ user.username }}"
    path: /home/{{ user.username }}/.ssh
    recurse: true
    state: directory
  become: true
  tags:
    - security
    - users

- name: Configure "{{ user.username }}" user ssh keys
  ansible.builtin.authorized_key:
    user: "{{ user.username }}"
    key: "{{ user.ssh_keys | join('\n') }}"
  when: user.ssh_keys is defined
  become: true
  tags:
    - security
    - users

---

- name: Add Docker repository key
  ansible.builtin.apt_key:
    id: 0EBFCD88
    url: https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg
    state: present
  become: true
  tags:
    - containerd
    - repositories
    - security

- name: Add Docker repository
  ansible.builtin.apt_repository:
    repo: deb https://download.docker.com/linux/{{ ansible_distribution | lower }} {{ ansible_distribution_release }} stable
    state: present
  become: true
  tags:
    - containerd
    - repositories

- name: Install "containerd.io" package
  ansible.builtin.apt:
    name: "{{ item }}"
    state: latest
    update_cache: true
  loop:
    - "docker-ce"
    - "docker-ce-cli"
    - "docker-ce-rootless-extras"
    - "containerd.io"
  become: true
  notify: Enable "containerd"
  tags:
    - containerd
    - packages

- name: Template "/etc/containerd/config.toml"
  ansible.builtin.template:
    src: config.toml.j2
    dest: /etc/containerd/config.toml
    owner: root
    group: root
    mode: 0644
  become: true
  notify: Restart "containerd"
  tags:
    - containerd

- name: Template "/etc/modules-load.d/containerd.conf"
  ansible.builtin.template:
    src: containerd.conf.j2
    dest: /etc/modules-load.d/containerd.conf
    owner: root
    group: root
    mode: 0644
  become: true
  notify: Restart server
  tags:
    - containerd

- name: Sysctl "/etc/sysctl.d/10-containerd-cri.conf"
  ansible.builtin.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/10-containerd-cri.conf
    sysctl_set: true
  loop_control:
    label: "{{ item.name }}"
  loop:
    - name: net.bridge.bridge-nf-call-iptables
      value: 1
    - name: net.ipv4.ip_forward
      value: 1
    - name: net.bridge.bridge-nf-call-ip6tables
      value: 1
  become: true
  notify: Restart "containerd"
  tags:
    - containerd
    - sysctl
